<!DOCTYPE html>
<html lang='ja'>
  <head>
    <meta charset="utf-8">
    <title>jsQR Demo</title>
    <script src="https://cozmo.github.io/jsQR/jsQR.js"></script>
    
    <style>
     body {
       font-family: sans-serif;
       color: #333;
       max-width: 640px;
       margin: 0 auto;
       position: relative;
     }

     h1 {
       margin: 10px 0;
       font-size: 40px;
     }

     #loadingMessage {
       text-align: center;
       padding: 40px;
       background-color: #eee;
     }

     #canvas {
       width: 100%;
     }

     #output {
       margin-top: 20px;
       background: #eee;
       padding: 10px;
       padding-bottom: 0;
     }

     #output div {
       padding-bottom: 10px;
       word-wrap: break-word;
     }

     #noQRFound {
       text-align: center;
     }
     /* テーブル  */
     table, th, td {
       border-collapse: collapse;
       border: 1px solid #ccc;
       line-height: 1.5;
     }

     table.type06 th {
       width: 150px;
       padding: 10px;
       font-weight: bold;
       vertical-align: top;
     }
     table.type06 td {
       width: 350px;
       padding: 10px;
       vertical-align: top;
     }

     tr:nth-child(even) {
       background: #d9d9d9;
     }

    </style>
  </head>
  <body>
    <h1>QRコードリーダーのテスト</h1>
    <div id="loadingMessage">ビデオが有効になっていません。</div>

    <!-- キャンバス -->
    <canvas id="canvas" hidden></canvas>
    
    <div id="output" hidden>
      <div id="outputMessage">QRコードが読み取れません。</div>
      <table id='qrcodes'>
        
      </table>
    </div>
    
    <div id='container'>
    </div>

    
    <script>
     // DOM要素
     const video = document.createElement("video");
     const canvasElement = document.getElementById("canvas");
     const canvas = canvasElement.getContext("2d");
     const loadingMessage = document.getElementById("loadingMessage");
     const outputContainer = document.getElementById("output");
     const outputMessage = document.getElementById("outputMessage");
     const table = document.getElementById('qrcodes');

     // 設定値
     const delay = 50; // ms
     
     // データ
     const scanned = new Set();  // 読み取り済みQRコード
     

     // 線を引く(QRコードを認識したとき用)
     function drawLine(begin, end, color) {
       canvas.beginPath();
       canvas.moveTo(begin.x, begin.y);
       canvas.lineTo(end.x, end.y);
       canvas.lineWidth = 4;
       canvas.strokeStyle = color;
       canvas.stroke();
     }

     // カメラを動作させる
     navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
       video.srcObject = stream;
       video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
       video.play();
       setTimeout(tick, delay);
     });

     
     function tick() {
       loadingMessage.innerText = "読み込んでいます..."
       if (video.readyState === video.HAVE_ENOUGH_DATA) {
         // 表示設定の変更
         loadingMessage.hidden = true;
         canvasElement.hidden = false;
         outputContainer.hidden = false;

         canvasElement.height = video.videoHeight;
         canvasElement.width = video.videoWidth;
         canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
         var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
         var code = jsQR(imageData.data, imageData.width, imageData.height);
         if (code && !scanned.has(code)) {
           // 読み取り済QRコード
           scanned.add(code);
           
           // 四角い赤線で囲う
           drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
           drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
           drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
           drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
           
           outputMessage.hidden = true;
           //outputData.innerText = code.data;
           
           const rowIndex = table.rows.length;

           const row = table.insertRow(rowIndex);
           const cell1 = row.insertCell(0);
           cell1.innerHTML = rowIndex + 1;

           const cell2 = row.insertCell(1);
           cell2.innerHTML = code;
           
           
         } else {
           /* outputMessage.hidden = false;
            * outputData.parentElement.hidden = true;*/
         }
       }
       setTimeout(tick, delay);
     }
    </script>
  </body>
</html>




